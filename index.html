<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Woes Armory Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0b08;
      --fg:#2a1e0f;
      --muted:#5a4630;

      /* OSRS-ish palette */
      --panel1:#ead7b3;
      --panel2:#d7bf92;
      --edge:#6b4b24;
      --edge2:#3f2a12;
      --gold:#caa44a;

      --danger:#8a1f1f;
      --ok:#1f6a2a;

      --slot:#f2e7cf;
      --slot2:#e6d2a8;
      --slotEdge: rgba(63,42,18,.24);
      --barBg: rgba(0,0,0,.14);
      --barFill: rgba(31,106,42,.85);
      --barFill2: rgba(202,164,74,.85);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--fg);
      font-family: Georgia, "Times New Roman", serif;
      overflow:hidden;

      background:
        radial-gradient(900px 600px at 50% 35%, rgba(255,235,180,.14), rgba(0,0,0,.88) 70%),
        radial-gradient(1200px 900px at 50% 60%, rgba(0,0,0,.35), rgba(0,0,0,.95) 80%),
        var(--bg);
    }

    .grain{
      position:fixed; inset:0; pointer-events:none; z-index:1;
      opacity:.10;
      background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,.25) 1px, transparent 0);
      background-size:3px 3px;
      mix-blend-mode: overlay;
    }

    main{
      position:relative;
      z-index:2;
      min-height:100%;
      display:grid;
      place-items:center;
      padding:18px;
    }

    .frame{
      width:min(1020px,100%);
      padding:14px;
      border-radius:10px;
      background: linear-gradient(180deg, rgba(202,164,74,.18), rgba(0,0,0,.15));
      box-shadow: 0 30px 120px rgba(0,0,0,.75);
    }

    .card{
      border-radius:8px;
      padding:18px;
      background:
        radial-gradient(1200px 600px at 40% 20%, rgba(255,255,255,.20), rgba(255,255,255,0) 65%),
        linear-gradient(180deg, var(--panel1), var(--panel2));
      border: 2px solid var(--edge);
      box-shadow:
        inset 0 0 0 2px rgba(0,0,0,.12),
        inset 0 0 0 4px rgba(255,255,255,.10);
    }

    .titlebar{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      border-bottom: 2px solid rgba(63,42,18,.22);
      padding-bottom:10px;
      margin-bottom:14px;
    }

    h1{
      margin:0;
      font-size: clamp(1.6rem, 3.6vw, 2.2rem);
      letter-spacing:.03em;
      text-transform: uppercase;
      color:#2a1b0c;
      text-shadow: 0 1px 0 rgba(255,255,255,.35);
    }

    .subtitle{
      margin:0;
      color:var(--muted);
      font-size:.98rem;
    }

    form{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0 10px}
    input,button{
      border-radius:6px;
      border: 2px solid rgba(63,42,18,.30);
      padding:10px 12px;
      font-size:1rem;
    }

    input{
      flex:1; min-width:240px;
      background: rgba(255,255,255,.55);
      color:#2a1e0f;
      outline:none;
    }
    input:focus{border-color: rgba(202,164,74,.9); box-shadow: 0 0 0 3px rgba(202,164,74,.22);}

    button{
      cursor:pointer;
      background: linear-gradient(180deg, rgba(202,164,74,.95), rgba(168,122,40,.95));
      color:#1e1408;
      font-weight:700;
      text-shadow: 0 1px 0 rgba(255,255,255,.35);
    }
    button:hover{filter:brightness(1.03)}
    button:disabled{opacity:.6;cursor:not-allowed}

    .status{
      min-height:22px;
      margin:8px 0 14px;
      color:var(--muted);
      font-size:.98rem;
    }
    .status.error{color:var(--danger); font-weight:700}
    .status.ok{color:var(--ok); font-weight:700}

    .grid{
      display:grid;
      grid-template-columns:repeat(4, minmax(0, 1fr));
      gap:10px;
      margin-bottom:12px
    }
    @media (max-width: 920px){ .grid{grid-template-columns:repeat(2, minmax(0, 1fr));} }
    @media (max-width: 520px){ .grid{grid-template-columns:1fr;} }

    .panel{
      border: 2px solid rgba(63,42,18,.22);
      border-radius:6px;
      padding:10px 12px;
      background: rgba(255,255,255,.30);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.35);
    }
    .k{font-size:.78rem;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
    .v{font-size:1.25rem;font-weight:800;margin-top:4px}

    /* Skills tab area */
    .skills-wrap{
      border:2px solid rgba(63,42,18,.22);
      border-radius:8px;
      background: rgba(255,255,255,.18);
      padding:10px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.30);
    }

    .skills-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:8px 8px 10px;
      border-bottom:1px solid rgba(63,42,18,.18);
      margin-bottom:10px;
    }

    .skills-title{
      font-weight:800;
      letter-spacing:.04em;
      text-transform:uppercase;
      color:#2a1b0c;
    }

    .skills-tools{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    .chip{
      border:2px solid rgba(63,42,18,.22);
      background: rgba(255,255,255,.35);
      border-radius:999px;
      padding:6px 10px;
      font-size:.92rem;
      color: var(--muted);
      user-select:none;
    }

    .skills-grid{
      display:grid;
      grid-template-columns:repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width: 820px){ .skills-grid{grid-template-columns:1fr;} }

    .skill{
      display:grid;
      grid-template-columns: 44px 1fr auto;
      gap:10px;
      align-items:center;
      padding:10px;
      border-radius:8px;
      border:2px solid var(--slotEdge);
      background: linear-gradient(180deg, var(--slot), var(--slot2));
      box-shadow: inset 0 1px 0 rgba(255,255,255,.35);
    }

    .icon{
      width:44px;height:44px;
      border-radius:10px;
      border:2px solid rgba(63,42,18,.26);
      background:
        radial-gradient(18px 18px at 30% 28%, rgba(255,255,255,.55), rgba(255,255,255,0) 60%),
        linear-gradient(180deg, rgba(202,164,74,.55), rgba(0,0,0,.08));
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.35),
        inset 0 0 0 2px rgba(0,0,0,.06);
      display:grid;
      place-items:center;
      font-weight:900;
      letter-spacing:.06em;
      color:#2a1b0c;
      text-transform:uppercase;
      font-size:.95rem;
    }

    .skill-main{min-width:0}
    .skill-name{
      font-weight:900;
      letter-spacing:.02em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .skill-sub{
      margin-top:4px;
      color: var(--muted);
      font-size:.90rem;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .lvl{
      font-weight:900;
      font-size:1.1rem;
      min-width:44px;
      text-align:right;
      color:#2a1b0c;
    }

    .bar{
      height:8px;
      border-radius:999px;
      background: var(--barBg);
      border:1px solid rgba(63,42,18,.20);
      overflow:hidden;
      margin-top:8px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.25);
    }
    .fill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--barFill), var(--barFill2));
    }

    .hint{
      margin-top:12px;
      font-size:.92rem;
      color:var(--muted);
      line-height:1.35;
    }
  </style>
</head>
<body>
  <div class="grain"></div>

  <main>
    <section class="frame">
      <div class="card">
        <div class="titlebar">
          <div>
            <h1>OSRS Armory</h1>
            <p class="subtitle">Lookup a player on the Old School Hiscores (demo fallback if blocked).</p>
          </div>
        </div>

        <form id="lookupForm">
          <input id="playerInput" name="player" placeholder="Enter RSN (e.g. Zezima)" autocomplete="off" required />
          <button type="submit" id="lookupBtn">Lookup</button>
          <button type="button" id="demoBtn">Load Demo</button>
        </form>

        <div class="status" id="status"></div>

        <div class="grid">
          <div class="panel"><div class="k">Player</div><div class="v" id="playerName">-</div></div>
          <div class="panel"><div class="k">Total Level</div><div class="v" id="totalLevel">-</div></div>
          <div class="panel"><div class="k">Total XP</div><div class="v" id="totalXp">-</div></div>
          <div class="panel"><div class="k">Combat Level</div><div class="v" id="combatLevel">-</div></div>
        </div>

        <div class="skills-wrap">
          <div class="skills-header">
            <div class="skills-title">Skills</div>
            <div class="skills-tools">
              <div class="chip" id="skillsMeta">No data loaded.</div>
            </div>
          </div>

          <div class="skills-grid" id="skillsGrid">
            <!-- skills render here -->
          </div>
        </div>

        <p class="hint">
          Tip: If you ever see demo again, it’s almost always the Worker/proxy URL or a temporary hiscores error.
        </p>
      </div>
    </section>
  </main>

  <script>
  (function(){
    // Your Cloudflare Worker base URL
    const PROXY_BASE = "https://cx.noahcastner.workers.dev";

    const DEMO = {
      name: "Demo Adventurer",
      overall: { rank: 123456, totalLevel: 1875, totalXp: 125000000 },
      stats: [
        ["Attack",82,2360000,120000], ["Defence",80,1980000,130000], ["Strength",85,3300000,99000], ["Hitpoints",84,3100000,100000],
        ["Ranged",79,1760000,140000], ["Prayer",70,737000,180000], ["Magic",81,2210000,110000], ["Cooking",90,5340000,78000],
        ["Woodcutting",76,1450000,170000], ["Fletching",77,1550000,195000], ["Fishing",75,1250000,190000], ["Firemaking",88,4600000,86000],
        ["Crafting",74,1200000,210000], ["Smithing",69,720000,250000], ["Mining",72,980000,210000], ["Herblore",60,270000,280000],
        ["Agility",68,650000,200000], ["Thieving",73,1050000,220000], ["Slayer",71,910000,240000], ["Farming",64,360000,260000],
        ["Runecraft",55,170000,320000], ["Hunter",58,240000,300000], ["Construction",62,320000,290000]
      ]
    };

    // Hiscores-lite ordering: row 0 = Overall, rows 1..23 = skills in this exact order:
    const HISCORES_SKILLS = [
      "Attack","Defence","Strength","Hitpoints","Ranged","Prayer","Magic","Cooking","Woodcutting","Fletching","Fishing","Firemaking",
      "Crafting","Smithing","Mining","Herblore","Agility","Thieving","Slayer","Farming","Runecraft","Hunter","Construction"
    ];

    // Short icon labels to feel like UI glyphs (no external images needed)
    const ICON_LABEL = {
      Attack:"ATK", Defence:"DEF", Strength:"STR", Hitpoints:"HP",
      Ranged:"RNG", Prayer:"PRY", Magic:"MAG", Cooking:"COOK",
      Woodcutting:"WC", Fletching:"FLET", Fishing:"FISH", Firemaking:"FM",
      Crafting:"CRFT", Smithing:"SMTH", Mining:"MINE", Herblore:"HERB",
      Agility:"AGI", Thieving:"THV", Slayer:"SLAY", Farming:"FARM",
      Runecraft:"RC", Hunter:"HUNT", Construction:"CONS"
    };

    const statusEl = document.getElementById("status");
    const playerNameEl = document.getElementById("playerName");
    const totalLevelEl = document.getElementById("totalLevel");
    const totalXpEl = document.getElementById("totalXp");
    const combatLevelEl = document.getElementById("combatLevel");
    const skillsGrid = document.getElementById("skillsGrid");
    const skillsMeta = document.getElementById("skillsMeta");
    const playerInput = document.getElementById("playerInput");
    const lookupBtn = document.getElementById("lookupBtn");
    const demoBtn = document.getElementById("demoBtn");

    const last = localStorage.getItem("woes_armory_last_player");
    if (last) playerInput.value = last;
    playerInput.focus();

    function setStatus(msg, type="") {
      statusEl.className = `status ${type}`.trim();
      statusEl.textContent = msg;
    }

    function calcCombat(levels){
      const atk=levels.Attack||1, str=levels.Strength||1, def=levels.Defence||1;
      const hp=levels.Hitpoints||10, pray=levels.Prayer||1, rng=levels.Ranged||1, mag=levels.Magic||1;
      const base = 0.25 * (def + hp + Math.floor(pray / 2));
      const melee = 0.325 * (atk + str);
      const range = 0.325 * (Math.floor(rng * 1.5));
      const mage  = 0.325 * (Math.floor(mag * 1.5));
      return Math.floor(base + Math.max(melee, range, mage));
    }

    // OSRS XP curve
    function xpForLevel(level){
      // returns XP required to reach "level"
      // level 1 => 0 XP
      if (level <= 1) return 0;
      let points = 0;
      for (let lvl = 1; lvl < level; lvl++){
        points += Math.floor(lvl + 300 * Math.pow(2, lvl / 7));
      }
      return Math.floor(points / 4);
    }

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function renderSkills(stats){
      const idx = Object.fromEntries(HISCORES_SKILLS.map((s,i)=>[s,i]));
      const sorted = stats.slice().sort((a,b)=> (idx[a[0]] ?? 9999) - (idx[b[0]] ?? 9999));

      skillsGrid.innerHTML = "";
      const frag = document.createDocumentFragment();

      for (const [skill, level, xp, rank] of sorted){
        const lvl = Number(level) || 1;
        const curXp = Number(xp) || 0;

        const nextLevel = clamp(lvl + 1, 2, 99);
        const curReq = xpForLevel(lvl);
        const nextReq = xpForLevel(nextLevel);

        let pct = 100;
        let progText = "Maxed";
        if (lvl < 99){
          const denom = Math.max(1, (nextReq - curReq));
          pct = clamp(((curXp - curReq) / denom) * 100, 0, 100);
          const toGo = Math.max(0, nextReq - curXp);
          progText = `${toGo.toLocaleString()} xp to ${nextLevel}`;
        }

        const el = document.createElement("div");
        el.className = "skill";
        el.innerHTML = `
          <div class="icon" title="${skill}">${(ICON_LABEL[skill] || skill.slice(0,3)).toUpperCase()}</div>
          <div class="skill-main">
            <div class="skill-name">${skill}</div>
            <div class="skill-sub">
              <span>XP: <b>${curXp.toLocaleString()}</b></span>
              <span>Rank: <b>${Number(rank).toLocaleString()}</b></span>
              <span>${progText}</span>
            </div>
            <div class="bar" aria-label="${skill} progress">
              <div class="fill" style="width:${pct.toFixed(1)}%"></div>
            </div>
          </div>
          <div class="lvl" title="Level">${lvl}</div>
        `;
        frag.appendChild(el);
      }

      skillsGrid.appendChild(frag);
    }

    function renderProfile(name, stats, overall){
      const levels = {};
      for (const [skill, level] of stats) levels[skill] = Number(level) || 1;

      playerNameEl.textContent = name;
      totalLevelEl.textContent = (overall?.totalLevel != null) ? Number(overall.totalLevel).toLocaleString() : "-";
      totalXpEl.textContent = (overall?.totalXp != null) ? Number(overall.totalXp).toLocaleString() : "-";
      combatLevelEl.textContent = calcCombat(levels);

      renderSkills(stats);

      const ts = new Date();
      skillsMeta.textContent = `Loaded ${HISCORES_SKILLS.length} skills • ${ts.toLocaleTimeString()}`;
    }

    function fetchWithTimeout(url, ms=9000){
      const controller = new AbortController();
      const t = setTimeout(()=>controller.abort(), ms);
      return fetch(url, { signal: controller.signal }).finally(()=>clearTimeout(t));
    }

    async function fetchHiscores(player){
      const url = `${PROXY_BASE.replace(/\/$/,"")}/hiscores?player=${encodeURIComponent(player)}`;
      const res = await fetchWithTimeout(url, 9000);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const text = await res.text();
      const rows = text.trim().split("\n");
      if (!rows.length) throw new Error("No rows returned");

      // Overall: rank,totalLevel,totalXP
      const overallRow = rows[0]?.split(",").map(Number);
      const overall = (overallRow && overallRow.length >= 3) ? {
        rank: overallRow[0],
        totalLevel: overallRow[1],
        totalXp: overallRow[2]
      } : null;

      const skills = [];
      for (let i = 0; i < HISCORES_SKILLS.length; i++){
        const line = rows[i+1];
        if (!line) continue;
        const [rank, level, xp] = line.split(",").map(Number);
        skills.push([HISCORES_SKILLS[i], level, xp, rank]);
      }

      if (!skills.length) throw new Error("Could not parse skills");
      return { name: player, skills, overall };
    }

    async function handleLookup(player){
      const p = (player || "").trim();
      if (!p) return;

      localStorage.setItem("woes_armory_last_player", p);

      setStatus("Looking up player...", "");
      lookupBtn.disabled = true;
      demoBtn.disabled = true;

      try{
        const data = await fetchHiscores(p);
        renderProfile(data.name, data.skills, data.overall);
        setStatus("Live hiscores loaded.", "ok");
      }catch(err){
        const msg = (err && err.name === "AbortError") ? "Request timed out" : (err?.message || "Unknown error");
        renderProfile(DEMO.name, DEMO.stats, DEMO.overall);
        setStatus(`Live lookup failed (${msg}). Showing demo profile.`, "error");
      }finally{
        lookupBtn.disabled = false;
        demoBtn.disabled = false;
      }
    }

    document.getElementById("lookupForm").addEventListener("submit", (e)=>{
      e.preventDefault();
      handleLookup(playerInput.value);
    });

    document.getElementById("demoBtn").addEventListener("click", ()=>{
      renderProfile(DEMO.name, DEMO.stats, DEMO.overall);
      setStatus("Demo profile loaded.", "ok");
    });

    // initial UI state
    skillsGrid.innerHTML = `<div class="skill" style="grid-column:1/-1; justify-content:center;">
      <div class="skill-main" style="text-align:center;">
        Enter an RSN and click <b>Lookup</b>.
        <div class="skill-sub" style="justify-content:center; margin-top:6px;">(Or click <b>Load Demo</b>.)</div>
      </div>
    </div>`;
  })();
  </script>
</body>
</html>
