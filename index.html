<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Woes Armory Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0b08;
      --fg:#2a1e0f;
      --muted:#5a4630;

      /* OSRS-ish palette */
      --panel1:#ead7b3;
      --panel2:#d7bf92;
      --edge:#6b4b24;
      --edge2:#3f2a12;
      --gold:#caa44a;

      --danger:#8a1f1f;
      --ok:#1f6a2a;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--fg);
      font-family: Georgia, "Times New Roman", serif;
      overflow:hidden;

      /* dark room + parchment glow */
      background:
        radial-gradient(900px 600px at 50% 35%, rgba(255,235,180,.14), rgba(0,0,0,.88) 70%),
        radial-gradient(1200px 900px at 50% 60%, rgba(0,0,0,.35), rgba(0,0,0,.95) 80%),
        var(--bg);
    }

    /* subtle texture */
    .grain{
      position:fixed; inset:0; pointer-events:none; z-index:1;
      opacity:.10;
      background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,.25) 1px, transparent 0);
      background-size:3px 3px;
      mix-blend-mode: overlay;
    }

    main{
      position:relative;
      z-index:2;
      min-height:100%;
      display:grid;
      place-items:center;
      padding:18px;
    }

    .frame{
      width:min(980px,100%);
      padding:14px;
      border-radius:10px;
      background: linear-gradient(180deg, rgba(202,164,74,.18), rgba(0,0,0,.15));
      box-shadow: 0 30px 120px rgba(0,0,0,.75);
    }

    .card{
      border-radius:8px;
      padding:18px;
      background:
        radial-gradient(1200px 600px at 40% 20%, rgba(255,255,255,.20), rgba(255,255,255,0) 65%),
        linear-gradient(180deg, var(--panel1), var(--panel2));
      border: 2px solid var(--edge);
      box-shadow:
        inset 0 0 0 2px rgba(0,0,0,.12),
        inset 0 0 0 4px rgba(255,255,255,.10);
    }

    .titlebar{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
      border-bottom: 2px solid rgba(63,42,18,.22);
      padding-bottom:10px;
      margin-bottom:14px;
    }

    h1{
      margin:0;
      font-size: clamp(1.6rem, 3.6vw, 2.2rem);
      letter-spacing:.03em;
      text-transform: uppercase;
      color:#2a1b0c;
      text-shadow: 0 1px 0 rgba(255,255,255,.35);
    }

    .subtitle{
      margin:0;
      color:var(--muted);
      font-size:.98rem;
    }

    form{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0 10px}
    input,button{
      border-radius:6px;
      border: 2px solid rgba(63,42,18,.30);
      padding:10px 12px;
      font-size:1rem;
    }

    input{
      flex:1; min-width:240px;
      background: rgba(255,255,255,.55);
      color:#2a1e0f;
      outline:none;
    }
    input:focus{border-color: rgba(202,164,74,.9); box-shadow: 0 0 0 3px rgba(202,164,74,.22);}

    button{
      cursor:pointer;
      background: linear-gradient(180deg, rgba(202,164,74,.95), rgba(168,122,40,.95));
      color:#1e1408;
      font-weight:700;
      text-shadow: 0 1px 0 rgba(255,255,255,.35);
    }
    button:hover{filter:brightness(1.03)}
    button:disabled{opacity:.6;cursor:not-allowed}

    .status{
      min-height:22px;
      margin:8px 0 14px;
      color:var(--muted);
      font-size:.98rem;
    }
    .status.error{color:var(--danger); font-weight:700}
    .status.ok{color:var(--ok); font-weight:700}

    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin-bottom:12px}
    .panel{
      border: 2px solid rgba(63,42,18,.22);
      border-radius:6px;
      padding:10px 12px;
      background: rgba(255,255,255,.30);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.35);
    }
    .k{font-size:.78rem;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
    .v{font-size:1.25rem;font-weight:800;margin-top:4px}

    table{
      width:100%;
      border-collapse:collapse;
      font-size:.98rem;
      background: rgba(255,255,255,.20);
      border:2px solid rgba(63,42,18,.22);
      border-radius:6px;
      overflow:hidden;
    }
    th,td{
      padding:9px 8px;
      border-bottom:1px solid rgba(63,42,18,.14);
      text-align:left;
    }
    th{
      color:var(--muted);
      font-weight:800;
      background: rgba(255,255,255,.22);
    }
    tr:last-child td{border-bottom:none}

    .hint{
      margin-top:12px;
      font-size:.92rem;
      color:var(--muted);
      line-height:1.35;
    }
    a{color:#2c5aa0}
  </style>
</head>
<body>
  <div class="grain"></div>

  <main>
    <section class="frame">
      <div class="card">
        <div class="titlebar">
          <div>
            <h1>OSRS Armory</h1>
            <p class="subtitle">Lookup a player on the Old School Hiscores (demo fallback if blocked).</p>
          </div>
        </div>

        <form id="lookupForm">
          <input id="playerInput" name="player" placeholder="Enter RSN (e.g. Zezima)" autocomplete="off" required />
          <button type="submit" id="lookupBtn">Lookup</button>
          <button type="button" id="demoBtn">Load Demo</button>
        </form>

        <div class="status" id="status"></div>

        <div class="grid">
          <div class="panel"><div class="k">Player</div><div class="v" id="playerName">-</div></div>
          <div class="panel"><div class="k">Total Level</div><div class="v" id="totalLevel">-</div></div>
          <div class="panel"><div class="k">Combat Level</div><div class="v" id="combatLevel">-</div></div>
        </div>

        <table>
          <thead><tr><th>Skill</th><th>Level</th><th>XP</th><th>Rank</th></tr></thead>
          <tbody id="skillsBody"><tr><td colspan="4">No data yet.</td></tr></tbody>
        </table>

        <p class="hint">
          If Lookup always shows demo: itâ€™s CORS. Fix = use a proxy (Cloudflare Worker). This is normal for browser-only apps. :contentReference[oaicite:2]{index=2}
        </p>
      </div>
    </section>
  </main>

  <script>
  (function(){
    // 1) PUT YOUR WORKER DOMAIN HERE after you deploy it:
    // Example: "https://woes-hiscores-proxy.yourname.workers.dev"
    const PROXY_BASE = "https://cx.noahcastner.workers.dev";

    // Demo fallback
    const DEMO = {
      name: "Demo Adventurer",
      stats: [
        ["Attack",82,2360000,120000], ["Defence",80,1980000,130000], ["Strength",85,3300000,99000], ["Hitpoints",84,3100000,100000],
        ["Ranged",79,1760000,140000], ["Prayer",70,737000,180000], ["Magic",81,2210000,110000], ["Cooking",90,5340000,78000],
        ["Woodcutting",76,1450000,170000], ["Fletching",77,1550000,195000], ["Fishing",75,1250000,190000], ["Firemaking",88,4600000,86000],
        ["Crafting",74,1200000,210000], ["Smithing",69,720000,250000], ["Mining",72,980000,210000], ["Herblore",60,270000,280000],
        ["Agility",68,650000,200000], ["Thieving",73,1050000,220000], ["Slayer",71,910000,240000], ["Farming",64,360000,260000],
        ["Runecraft",55,170000,320000], ["Hunter",58,240000,300000], ["Construction",62,320000,290000]
      ]
    };

    const HISCORES_SKILLS = [
      "Attack","Defence","Strength","Hitpoints","Ranged","Prayer","Magic","Cooking","Woodcutting","Fletching","Fishing","Firemaking",
      "Crafting","Smithing","Mining","Herblore","Agility","Thieving","Slayer","Farming","Runecraft","Hunter","Construction"
    ];

    const statusEl = document.getElementById("status");
    const playerNameEl = document.getElementById("playerName");
    const totalLevelEl = document.getElementById("totalLevel");
    const combatLevelEl = document.getElementById("combatLevel");
    const skillsBody = document.getElementById("skillsBody");
    const playerInput = document.getElementById("playerInput");
    const lookupBtn = document.getElementById("lookupBtn");
    const demoBtn = document.getElementById("demoBtn");

    const last = localStorage.getItem("woes_armory_last_player");
    if (last) playerInput.value = last;
    playerInput.focus();

    function setStatus(msg, type="") {
      statusEl.className = `status ${type}`.trim();
      statusEl.textContent = msg;
    }

    function calcCombat(levels){
      const atk=levels.Attack||1, str=levels.Strength||1, def=levels.Defence||1;
      const hp=levels.Hitpoints||10, pray=levels.Prayer||1, rng=levels.Ranged||1, mag=levels.Magic||1;
      const base = 0.25 * (def + hp + Math.floor(pray / 2));
      const melee = 0.325 * (atk + str);
      const range = 0.325 * (Math.floor(rng * 1.5));
      const mage  = 0.325 * (Math.floor(mag * 1.5));
      return Math.floor(base + Math.max(melee, range, mage));
    }

    function renderProfile(name, stats, totalLevelOverride=null){
      const levels = {};
      let total = 0;
      skillsBody.innerHTML = "";

      const idx = Object.fromEntries(HISCORES_SKILLS.map((s,i)=>[s,i]));
      const sorted = stats.slice().sort((a,b)=> (idx[a[0]] ?? 9999) - (idx[b[0]] ?? 9999));

      for (const [skill, level, xp, rank] of sorted){
        levels[skill] = level;
        total += Number(level) || 0;
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${skill}</td><td>${level}</td><td>${Number(xp).toLocaleString()}</td><td>${Number(rank).toLocaleString()}</td>`;
        skillsBody.appendChild(tr);
      }

      playerNameEl.textContent = name;
      totalLevelEl.textContent = (Number.isFinite(totalLevelOverride) && totalLevelOverride > 0) ? totalLevelOverride : total;
      combatLevelEl.textContent = calcCombat(levels);
    }

    function fetchWithTimeout(url, ms=9000){
      const controller = new AbortController();
      const t = setTimeout(()=>controller.abort(), ms);
      return fetch(url, { signal: controller.signal }).finally(()=>clearTimeout(t));
    }

    async function fetchHiscores(player){
      if (PROXY_BASE.includes("cx.noahcastner.workers.dev")) {
        throw new Error("Proxy not configured (set PROXY_BASE)");
      }

      const url = `${PROXY_BASE.replace(/\/$/,"")}/hiscores?player=${encodeURIComponent(player)}`;
      const res = await fetchWithTimeout(url, 9000);

      // 404/500/etc should still show a readable message
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const text = await res.text();
      const rows = text.trim().split("\n");
      if (!rows.length) throw new Error("No rows returned");

      // Row 0: Overall => rank,totalLevel,totalXP
      const overall = rows[0]?.split(",").map(Number);
      const totalLevel = overall && overall.length >= 3 ? overall[1] : null;

      const skills = [];
      for (let i = 0; i < HISCORES_SKILLS.length; i++){
        const line = rows[i+1];
        if (!line) continue;
        const [rank, level, xp] = line.split(",").map(Number);
        skills.push([HISCORES_SKILLS[i], level, xp, rank]);
      }

      if (!skills.length) throw new Error("Could not parse skills");
      return { name: player, skills, totalLevel };
    }

    async function handleLookup(player){
      const p = (player || "").trim();
      if (!p) return;

      localStorage.setItem("woes_armory_last_player", p);

      setStatus("Looking up player...", "");
      lookupBtn.disabled = true;
      demoBtn.disabled = true;

      try{
        const data = await fetchHiscores(p);
        renderProfile(data.name, data.skills, data.totalLevel);
        setStatus("Live hiscores loaded.", "ok");
      }catch(err){
        const msg = (err && err.name === "AbortError") ? "Request timed out" : (err?.message || "Unknown error");
        renderProfile(DEMO.name, DEMO.stats, null);
        setStatus(`Live lookup failed (${msg}). Showing demo profile.`, "error");
      }finally{
        lookupBtn.disabled = false;
        demoBtn.disabled = false;
      }
    }

    document.getElementById("lookupForm").addEventListener("submit", (e)=>{
      e.preventDefault();
      handleLookup(playerInput.value);
    });

    document.getElementById("demoBtn").addEventListener("click", ()=>{
      renderProfile(DEMO.name, DEMO.stats, null);
      setStatus("Demo profile loaded.", "ok");
    });
  })();
  </script>
</body>
</html>
