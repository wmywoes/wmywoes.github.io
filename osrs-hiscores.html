<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OSRS Armory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      /* LIGHT */
      --bg:#0b0b08;
      --fg:#2a1e0f;
      --muted:#5a4630;

      --panel1:#ead7b3;
      --panel2:#d7bf92;
      --edge:#6b4b24;

      --danger:#8a1f1f;
      --ok:#1f6a2a;

      --slot:#f2e7cf;
      --slot2:#e6d2a8;
      --slotEdge: rgba(63,42,18,.24);

      --barBg: rgba(0,0,0,.14);
      --barFill: rgba(31,106,42,.85);
      --barFill2: rgba(202,164,74,.85);

      --cardShadow: 0 30px 120px rgba(0,0,0,.75);

      /* OSRS button vibe */
      --btnTop: rgba(240, 210, 130, .95);
      --btnBot: rgba(176, 122, 44, .95);
      --btnEdge: rgba(63,42,18,.55);
      --btnInset: rgba(255,255,255,.25);
      --btnText: #1e1408;
      --btnIdle: rgba(255,255,255,.10);
      --btnActiveGlow: rgba(202,164,74,.30);
    }

    html[data-theme="dark"]{
      /* DARK */
      --bg:#07070a;
      --fg:#e8e8ef;
      --muted:rgba(232,232,239,.70);

      --panel1:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.03);
      --edge:rgba(255,255,255,.16);

      --slot:rgba(0,0,0,.28);
      --slot2:rgba(0,0,0,.18);
      --slotEdge: rgba(255,255,255,.16);

      --barBg: rgba(255,255,255,.12);
      --barFill: rgba(120,255,180,.75);
      --barFill2: rgba(120,255,180,.45);

      --cardShadow: 0 30px 120px rgba(0,0,0,.85);

      --btnTop: rgba(120,255,180,.45);
      --btnBot: rgba(0,0,0,.25);
      --btnEdge: rgba(255,255,255,.18);
      --btnInset: rgba(255,255,255,.08);
      --btnText: var(--fg);
      --btnIdle: rgba(0,0,0,.12);
      --btnActiveGlow: rgba(120,255,180,.18);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--fg);
      font-family: Georgia, "Times New Roman", serif;
      overflow:hidden;

      background:
        radial-gradient(900px 600px at 50% 35%, rgba(255,235,180,.14), rgba(0,0,0,.88) 70%),
        radial-gradient(1200px 900px at 50% 60%, rgba(0,0,0,.35), rgba(0,0,0,.95) 80%),
        var(--bg);
    }
    html[data-theme="dark"] body{
      background:
        radial-gradient(900px 600px at 50% 35%, rgba(120,255,180,.10), rgba(0,0,0,.90) 70%),
        radial-gradient(1200px 900px at 50% 60%, rgba(0,0,0,.35), rgba(0,0,0,.97) 80%),
        var(--bg);
    }

    .grain{
      position:fixed; inset:0; pointer-events:none; z-index:1;
      opacity:.10;
      background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,.25) 1px, transparent 0);
      background-size:3px 3px;
      mix-blend-mode: overlay;
    }
    html[data-theme="dark"] .grain{opacity:.07}

    main{
      position:relative;
      z-index:2;
      min-height:100%;
      display:grid;
      place-items:center;
      padding:18px;
    }

    .frame{
      width:min(1080px,100%);
      padding:14px;
      border-radius:10px;
      background: linear-gradient(180deg, rgba(202,164,74,.18), rgba(0,0,0,.15));
      box-shadow: var(--cardShadow);
    }
    html[data-theme="dark"] .frame{
      background: linear-gradient(180deg, rgba(120,255,180,.12), rgba(0,0,0,.18));
    }

    .card{
      border-radius:10px;
      padding:18px;
      background:
        radial-gradient(1200px 600px at 40% 20%, rgba(255,255,255,.20), rgba(255,255,255,0) 65%),
        linear-gradient(180deg, var(--panel1), var(--panel2));
      border: 2px solid var(--edge);
      box-shadow:
        inset 0 0 0 2px rgba(0,0,0,.12),
        inset 0 0 0 4px rgba(255,255,255,.10);
    }
    html[data-theme="dark"] .card{
      box-shadow:
        inset 0 0 0 2px rgba(0,0,0,.35),
        inset 0 0 0 4px rgba(255,255,255,.06);
    }

    .titlebar{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      border-bottom: 2px solid rgba(63,42,18,.22);
      padding-bottom:10px;
      margin-bottom:14px;
    }
    html[data-theme="dark"] .titlebar{border-bottom-color: rgba(255,255,255,.12);}

    h1{
      margin:0;
      font-size: clamp(1.6rem, 3.6vw, 2.2rem);
      letter-spacing:.03em;
      text-transform: uppercase;
      color: var(--fg);
      text-shadow: 0 1px 0 rgba(255,255,255,.20);
    }
    html[data-theme="dark"] h1{ text-shadow:none; }

    .subtitle{
      margin:6px 0 0;
      color:var(--muted);
      font-size:.98rem;
    }

    /* Theme toggle */
    .toggle{
      display:flex;
      align-items:center;
      gap:10px;
      user-select:none;
      color: var(--muted);
      font-size:.95rem;
      white-space:nowrap;
    }
    .switch{
      position:relative;
      width:54px;
      height:28px;
      border-radius:999px;
      border:2px solid rgba(63,42,18,.30);
      background: rgba(255,255,255,.35);
      cursor:pointer;
      flex: 0 0 auto;
    }
    html[data-theme="dark"] .switch{
      border-color: rgba(255,255,255,.18);
      background: rgba(0,0,0,.25);
    }
    .knob{
      position:absolute;
      top:3px; left:3px;
      width:20px; height:20px;
      border-radius:999px;
      background: linear-gradient(180deg, rgba(202,164,74,.95), rgba(168,122,40,.95));
      box-shadow: inset 0 1px 0 rgba(255,255,255,.30);
      transition: transform .18s ease;
    }
    html[data-theme="dark"] .knob{
      background: linear-gradient(180deg, rgba(120,255,180,.85), rgba(120,255,180,.45));
    }
    .switch[data-on="1"] .knob{ transform: translateX(26px); }

    form{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0 10px}
    input,button{
      border-radius:10px;
      border: 2px solid rgba(63,42,18,.30);
      padding:10px 12px;
      font-size:1rem;
    }
    html[data-theme="dark"] input, html[data-theme="dark"] button{border-color: rgba(255,255,255,.18);}

    input{
      flex:1; min-width:240px;
      background: rgba(255,255,255,.55);
      color:#2a1e0f;
      outline:none;
    }
    html[data-theme="dark"] input{background: rgba(0,0,0,.26); color: var(--fg);}

    input:focus{
      border-color: rgba(202,164,74,.9);
      box-shadow: 0 0 0 3px rgba(202,164,74,.22);
    }
    html[data-theme="dark"] input:focus{
      border-color: rgba(120,255,180,.55);
      box-shadow: 0 0 0 3px rgba(120,255,180,.16);
    }

    /* OSRS-ish buttons */
    .osrs-btn{
      cursor:pointer;
      background: linear-gradient(180deg, var(--btnTop), var(--btnBot));
      color: var(--btnText);
      font-weight:900;
      letter-spacing:.03em;
      text-transform:uppercase;
      text-shadow: 0 1px 0 rgba(255,255,255,.25);
      border: 2px solid var(--btnEdge);
      box-shadow:
        inset 0 1px 0 var(--btnInset),
        0 2px 0 rgba(0,0,0,.20);
    }
    .osrs-btn:hover{filter:brightness(1.03)}
    .osrs-btn:active{
      transform: translateY(1px);
      box-shadow: inset 0 1px 0 var(--btnInset);
    }
    .osrs-btn:disabled{opacity:.6;cursor:not-allowed}

    .status{
      min-height:22px;
      margin:8px 0 12px;
      color:var(--muted);
      font-size:.98rem;
    }
    .status.error{color:var(--danger); font-weight:700}
    .status.ok{color:var(--ok); font-weight:700}

    .grid{
      display:grid;
      grid-template-columns:repeat(4, minmax(0, 1fr));
      gap:10px;
      margin:10px 0 12px;
    }
    @media (max-width: 920px){ .grid{grid-template-columns:repeat(2, minmax(0, 1fr));} }
    @media (max-width: 520px){ .grid{grid-template-columns:1fr;} }

    .panel{
      border: 2px solid rgba(63,42,18,.22);
      border-radius:10px;
      padding:10px 12px;
      background: rgba(255,255,255,.30);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.35);
    }
    html[data-theme="dark"] .panel{
      border-color: rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .k{font-size:.78rem;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
    .v{font-size:1.25rem;font-weight:900;margin-top:4px}

    /* Tabs */
    .tabs{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin: 6px 0 12px;
    }
    .tab{
      padding:10px 14px;
      border-radius:12px;
      background: var(--btnIdle);
      border:2px solid rgba(63,42,18,.22);
      color: var(--muted);
      font-weight:900;
      letter-spacing:.03em;
      text-transform:uppercase;
      cursor:pointer;
      user-select:none;
    }
    html[data-theme="dark"] .tab{
      border-color: rgba(255,255,255,.12);
    }
    .tab.active{
      background: linear-gradient(180deg, var(--btnTop), var(--btnBot));
      color: var(--btnText);
      border-color: var(--btnEdge);
      box-shadow:
        inset 0 1px 0 var(--btnInset),
        0 0 0 4px var(--btnActiveGlow);
    }

    .view{display:none}
    .view.active{display:block}

    /* Skills list */
    .skills-wrap{
      border:2px solid rgba(63,42,18,.22);
      border-radius:10px;
      background: rgba(255,255,255,.18);
      padding:10px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.30);
    }
    html[data-theme="dark"] .skills-wrap{
      border-color: rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }

    .skills-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:8px 8px 10px;
      border-bottom:1px solid rgba(63,42,18,.18);
      margin-bottom:10px;
    }
    html[data-theme="dark"] .skills-header{border-bottom-color: rgba(255,255,255,.10);}

    .skills-title{
      font-weight:900;
      letter-spacing:.04em;
      text-transform:uppercase;
      color: var(--fg);
    }

    .chip{
      border:2px solid rgba(63,42,18,.22);
      background: rgba(255,255,255,.35);
      border-radius:999px;
      padding:6px 10px;
      font-size:.92rem;
      color: var(--muted);
      user-select:none;
    }
    html[data-theme="dark"] .chip{
      border-color: rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
    }

    .skills-grid{
      display:grid;
      grid-template-columns:repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width: 820px){ .skills-grid{grid-template-columns:1fr;} }

    .skill{
      display:grid;
      grid-template-columns: 44px 1fr auto;
      gap:10px;
      align-items:center;
      padding:10px;
      border-radius:10px;
      border:2px solid var(--slotEdge);
      background: linear-gradient(180deg, var(--slot), var(--slot2));
      box-shadow: inset 0 1px 0 rgba(255,255,255,.35);
    }
    html[data-theme="dark"] .skill{box-shadow: inset 0 1px 0 rgba(255,255,255,.06);}

    .icon{
      width:44px;height:44px;
      border-radius:12px;
      border:2px solid rgba(63,42,18,.26);
      display:grid;
      place-items:center;
      color: var(--fg);
      background:
        radial-gradient(18px 18px at 30% 28%, rgba(255,255,255,.45), rgba(255,255,255,0) 60%),
        linear-gradient(180deg, rgba(202,164,74,.40), rgba(0,0,0,.08));
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.30),
        inset 0 0 0 2px rgba(0,0,0,.06);
    }
    html[data-theme="dark"] .icon{
      border-color: rgba(255,255,255,.16);
      background:
        radial-gradient(18px 18px at 30% 28%, rgba(255,255,255,.10), rgba(255,255,255,0) 60%),
        linear-gradient(180deg, rgba(120,255,180,.16), rgba(0,0,0,.20));
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.08),
        inset 0 0 0 2px rgba(0,0,0,.20);
    }
    .icon svg{width:24px;height:24px;display:block}

    .skill-main{min-width:0}
    .skill-name{
      font-weight:900;
      letter-spacing:.02em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .skill-sub{
      margin-top:4px;
      color: var(--muted);
      font-size:.90rem;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .lvl{
      font-weight:900;
      font-size:1.1rem;
      min-width:44px;
      text-align:right;
      color: var(--fg);
    }

    .bar{
      height:8px;
      border-radius:999px;
      background: var(--barBg);
      border:1px solid rgba(63,42,18,.20);
      overflow:hidden;
      margin-top:8px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.25);
    }
    html[data-theme="dark"] .bar{
      border-color: rgba(255,255,255,.14);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .fill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--barFill), var(--barFill2));
    }

    /* Activities view */
    .acts{
      display:grid;
      grid-template-columns:repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width: 820px){ .acts{grid-template-columns:1fr;} }

    .act{
      border:2px solid rgba(63,42,18,.22);
      border-radius:10px;
      background: rgba(255,255,255,.18);
      padding:12px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.30);
    }
    html[data-theme="dark"] .act{
      border-color: rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .act h3{
      margin:0 0 8px;
      font-size:1.02rem;
      text-transform:uppercase;
      letter-spacing:.05em;
    }
    .act p{margin:0;color:var(--muted);line-height:1.35}
    .list{margin-top:8px;display:flex;flex-direction:column;gap:6px}
    .row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:8px 10px;
      border-radius:10px;
      border:2px solid var(--slotEdge);
      background: linear-gradient(180deg, var(--slot), var(--slot2));
    }
    html[data-theme="dark"] .row{
      background: linear-gradient(180deg, var(--slot), var(--slot2));
    }
    .row b{font-weight:900}
    .mini{color:var(--muted);font-size:.92rem}
  </style>
</head>
<body>
  <div class="grain"></div>

  <main>
    <section class="frame">
      <div class="card">
        <div class="titlebar">
          <div>
            <h1>OSRS Armory</h1>
            <p class="subtitle">Skills + quick stats. Shareable URLs supported.</p>
          </div>

          <div class="toggle" title="Toggle theme">
            <span id="themeLabel">Light</span>
            <div class="switch" id="themeSwitch" data-on="0" role="switch" aria-checked="false" tabindex="0">
              <div class="knob"></div>
            </div>
          </div>
        </div>

        <form id="lookupForm">
          <input id="playerInput" name="player" placeholder="Enter RSN (e.g. Tely)" autocomplete="off" required />
          <button type="submit" class="osrs-btn" id="lookupBtn">Lookup</button>
        </form>

        <div class="status" id="status"></div>

        <div class="grid">
          <div class="panel"><div class="k">Player</div><div class="v" id="playerName">-</div></div>
          <div class="panel"><div class="k">Total Level</div><div class="v" id="totalLevel">-</div></div>
          <div class="panel"><div class="k">Total XP</div><div class="v" id="totalXp">-</div></div>
          <div class="panel"><div class="k">Combat Level</div><div class="v" id="combatLevel">-</div></div>
        </div>

        <div class="tabs" aria-label="tabs">
          <div class="tab active" data-tab="skills">Skills</div>
          <div class="tab" data-tab="activities">Activities</div>
        </div>

        <div class="view active" id="view-skills">
          <div class="skills-wrap">
            <div class="skills-header">
              <div class="skills-title">Skills</div>
              <div class="chip" id="skillsMeta">No data loaded.</div>
            </div>
            <div class="skills-grid" id="skillsGrid"></div>
          </div>
        </div>

        <div class="view" id="view-activities">
          <div class="acts">
            <div class="act">
              <h3>Top skills (by XP)</h3>
              <p class="mini">Where most of your grind lives.</p>
              <div class="list" id="topSkills"></div>
            </div>

            <div class="act">
              <h3>Next levels</h3>
              <p class="mini">Closest to leveling up next.</p>
              <div class="list" id="nextLevels"></div>
            </div>

            <div class="act">
              <h3>Combat focus</h3>
              <p class="mini">Melee / Ranged / Magic leaning (rough read).</p>
              <div class="list" id="combatFocus"></div>
            </div>

            <div class="act">
              <h3>Milestones</h3>
              <p class="mini">Total XP vibe check.</p>
              <div class="list" id="milestones"></div>
            </div>
          </div>
        </div>

      </div>
    </section>
  </main>

  <script>
  (function(){
    // Cloudflare Worker base URL
    const PROXY_BASE = "https://cx.noahcastner.workers.dev";

    // Skills order (includes Sailing)
    const HISCORES_SKILLS = [
      "Attack","Defence","Strength","Hitpoints","Ranged","Prayer","Magic","Cooking","Woodcutting","Fletching","Fishing","Firemaking",
      "Crafting","Smithing","Mining","Herblore","Agility","Thieving","Slayer","Farming","Runecraft","Hunter","Construction",
      "Sailing"
    ];

    const statusEl = document.getElementById("status");
    const playerNameEl = document.getElementById("playerName");
    const totalLevelEl = document.getElementById("totalLevel");
    const totalXpEl = document.getElementById("totalXp");
    const combatLevelEl = document.getElementById("combatLevel");
    const skillsGrid = document.getElementById("skillsGrid");
    const skillsMeta = document.getElementById("skillsMeta");
    const playerInput = document.getElementById("playerInput");
    const lookupBtn = document.getElementById("lookupBtn");

    // Activities UI
    const topSkillsEl = document.getElementById("topSkills");
    const nextLevelsEl = document.getElementById("nextLevels");
    const combatFocusEl = document.getElementById("combatFocus");
    const milestonesEl = document.getElementById("milestones");

    // Theme toggle
    const themeSwitch = document.getElementById("themeSwitch");
    const themeLabel = document.getElementById("themeLabel");

    // Tabs
    const tabs = Array.from(document.querySelectorAll(".tab"));
    const viewSkills = document.getElementById("view-skills");
    const viewActivities = document.getElementById("view-activities");

    let lastLoaded = null; // {name, skills, overall}

    function setTheme(theme){
      const t = (theme === "dark") ? "dark" : "light";
      document.documentElement.setAttribute("data-theme", t);
      localStorage.setItem("woes_armory_theme", t);
      themeSwitch.dataset.on = (t === "dark") ? "1" : "0";
      themeSwitch.setAttribute("aria-checked", t === "dark" ? "true" : "false");
      themeLabel.textContent = t === "dark" ? "Dark" : "Light";
    }
    function toggleTheme(){
      const cur = document.documentElement.getAttribute("data-theme") || "light";
      setTheme(cur === "dark" ? "light" : "dark");
    }
    themeSwitch.addEventListener("click", toggleTheme);
    themeSwitch.addEventListener("keydown", (e)=>{
      if (e.key === "Enter" || e.key === " "){
        e.preventDefault();
        toggleTheme();
      }
    });
    setTheme(localStorage.getItem("woes_armory_theme") || "light");

    function setTab(which){
      for (const t of tabs) t.classList.toggle("active", t.dataset.tab === which);
      viewSkills.classList.toggle("active", which === "skills");
      viewActivities.classList.toggle("active", which === "activities");
      // If Activities is opened and we have data, ensure it’s rendered.
      if (which === "activities" && lastLoaded) renderActivities(lastLoaded);
    }
    tabs.forEach(t => t.addEventListener("click", () => setTab(t.dataset.tab)));

    function setStatus(msg, type="") {
      statusEl.className = `status ${type}`.trim();
      statusEl.textContent = msg;
    }

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function calcCombat(levels){
      const atk=levels.Attack||1, str=levels.Strength||1, def=levels.Defence||1;
      const hp=levels.Hitpoints||10, pray=levels.Prayer||1, rng=levels.Ranged||1, mag=levels.Magic||1;
      const base = 0.25 * (def + hp + Math.floor(pray / 2));
      const melee = 0.325 * (atk + str);
      const range = 0.325 * (Math.floor(rng * 1.5));
      const mage  = 0.325 * (Math.floor(mag * 1.5));
      return Math.floor(base + Math.max(melee, range, mage));
    }

    // OSRS XP curve
    function xpForLevel(level){
      if (level <= 1) return 0;
      let points = 0;
      for (let lvl = 1; lvl < level; lvl++){
        points += Math.floor(lvl + 300 * Math.pow(2, lvl / 7));
      }
      return Math.floor(points / 4);
    }

    // Simple inline icons (same set you liked)
    function svgIcon(kind){
      const common = 'fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"';
      switch(kind){
        case "sword": return `<svg viewBox="0 0 24 24" ${common}><path d="M14 3l7 7-9 9-7 2 2-7 9-9Z"/><path d="M10 7l7 7"/><path d="M6 18l-1 3 3-1"/></svg>`;
        case "shield": return `<svg viewBox="0 0 24 24" ${common}><path d="M12 2l8 4v6c0 6-4 9-8 10-4-1-8-4-8-10V6l8-4Z"/><path d="M12 6v12"/></svg>`;
        case "heart": return `<svg viewBox="0 0 24 24" ${common}><path d="M12 21s-7-4.5-9-9a5 5 0 0 1 9-3 5 5 0 0 1 9 3c-2 4.5-9 9-9 9Z"/></svg>`;
        case "bow": return `<svg viewBox="0 0 24 24" ${common}><path d="M4 12c4-8 12-10 16-10-1 6-1 14 0 20-4 0-12-2-16-10Z"/><path d="M4 12h16"/><path d="M12 6l4 6-4 6"/></svg>`;
        case "spark": return `<svg viewBox="0 0 24 24" ${common}><path d="M12 2l2 6 6 2-6 2-2 6-2-6-6-2 6-2 2-6Z"/><path d="M19 14l1 3 3 1-3 1-1 3-1-3-3-1 3-1 1-3Z"/></svg>`;
        case "leaf": return `<svg viewBox="0 0 24 24" ${common}><path d="M20 4c-8 1-14 7-14 15 7 0 14-6 15-14-1-1-1-1-1-1Z"/><path d="M6 18c2-4 6-7 12-10"/></svg>`;
        case "pick": return `<svg viewBox="0 0 24 24" ${common}><path d="M3 7c6-5 12-5 18 0"/><path d="M12 7v14"/><path d="M9 21h6"/></svg>`;
        case "axe": return `<svg viewBox="0 0 24 24" ${common}><path d="M14 4c3 0 6 2 7 5-4 2-7 1-10-1"/><path d="M9 3l6 6"/><path d="M7 5l12 12"/><path d="M5 7l12 12"/></svg>`;
        case "fish": return `<svg viewBox="0 0 24 24" ${common}><path d="M3 12s4-6 10-6 8 6 8 6-2 6-8 6-10-6-10-6Z"/><path d="M21 12l2-2v4l-2-2Z"/><path d="M9 10h.01"/></svg>`;
        case "fire": return `<svg viewBox="0 0 24 24" ${common}><path d="M12 2s4 4 4 8a4 4 0 0 1-8 0c0-3 2-5 4-8Z"/><path d="M8 14c-2 2-2 8 4 8s6-6 4-8"/></svg>`;
        case "hammer": return `<svg viewBox="0 0 24 24" ${common}><path d="M14 3l7 7-4 1-1 4-7-7 5-5Z"/><path d="M2 22l10-10"/></svg>`;
        case "boat": return `<svg viewBox="0 0 24 24" ${common}><path d="M3 17h18"/><path d="M5 17l3 4h8l3-4"/><path d="M7 12l5-7 5 7"/><path d="M12 5v7"/></svg>`;
        default: return `<svg viewBox="0 0 24 24" ${common}><path d="M12 2v20"/><path d="M2 12h20"/></svg>`;
      }
    }

    function iconKindForSkill(skill){
      switch(skill){
        case "Attack": return "sword";
        case "Defence": return "shield";
        case "Strength": return "sword";
        case "Hitpoints": return "heart";
        case "Ranged": return "bow";
        case "Prayer": return "spark";
        case "Magic": return "spark";
        case "Cooking": return "fire";
        case "Woodcutting": return "axe";
        case "Fletching": return "bow";
        case "Fishing": return "fish";
        case "Firemaking": return "fire";
        case "Crafting": return "hammer";
        case "Smithing": return "hammer";
        case "Mining": return "pick";
        case "Herblore": return "leaf";
        case "Agility": return "spark";
        case "Thieving": return "spark";
        case "Slayer": return "sword";
        case "Farming": return "leaf";
        case "Runecraft": return "spark";
        case "Hunter": return "bow";
        case "Construction": return "hammer";
        case "Sailing": return "boat";
        default: return "spark";
      }
    }

    function renderSkills(stats){
      skillsGrid.innerHTML = "";
      const frag = document.createDocumentFragment();

      for (const [skill, level, xp, rank] of stats){
        const lvl = Number(level) || 1;
        const curXp = Number(xp) || 0;

        const nextLevel = clamp(lvl + 1, 2, 99);
        const curReq = xpForLevel(lvl);
        const nextReq = xpForLevel(nextLevel);

        let pct = 100;
        let progText = "Maxed";
        if (lvl < 99){
          const denom = Math.max(1, (nextReq - curReq));
          pct = clamp(((curXp - curReq) / denom) * 100, 0, 100);
          const toGo = Math.max(0, nextReq - curXp);
          progText = `${toGo.toLocaleString()} xp to ${nextLevel}`;
        }

        const el = document.createElement("div");
        el.className = "skill";
        el.innerHTML = `
          <div class="icon" title="${skill}">${svgIcon(iconKindForSkill(skill))}</div>
          <div class="skill-main">
            <div class="skill-name">${skill}</div>
            <div class="skill-sub">
              <span>XP: <b>${curXp.toLocaleString()}</b></span>
              <span>Rank: <b>${Number(rank).toLocaleString()}</b></span>
              <span>${progText}</span>
            </div>
            <div class="bar" aria-label="${skill} progress">
              <div class="fill" style="width:${pct.toFixed(1)}%"></div>
            </div>
          </div>
          <div class="lvl" title="Level">${lvl}</div>
        `;
        frag.appendChild(el);
      }

      skillsGrid.appendChild(frag);
    }

    function renderRow(parent, left, right, smallRight=false){
      const el = document.createElement("div");
      el.className = "row";
      el.innerHTML = `
        <div><b>${left}</b></div>
        <div class="${smallRight ? "mini" : ""}">${right}</div>
      `;
      parent.appendChild(el);
    }

    function nearestMilestone(totalXp){
      const ms = [1e6, 10e6, 25e6, 50e6, 75e6, 100e6, 150e6, 200e6, 300e6, 400e6, 500e6, 750e6, 1e9];
      let last = 0;
      for (const m of ms){
        if (totalXp >= m) last = m;
        else break;
      }
      const next = ms.find(m => m > totalXp) || null;
      return { last, next };
    }

    function renderActivities(data){
      const stats = data.skills;
      const map = Object.fromEntries(stats.map(([s,l,x,r]) => [s, {level:+l||1, xp:+x||0, rank:+r||0}]));
      const totalXp = data.overall?.totalXp ?? null;

      // Top skills by XP (exclude Overall)
      const top = stats.slice()
        .sort((a,b)=> (b[2]-a[2]))
        .slice(0, 5);

      topSkillsEl.innerHTML = "";
      for (const [skill, level, xp] of top){
        renderRow(topSkillsEl, `${skill} (${level})`, `${Number(xp).toLocaleString()} xp`, true);
      }

      // Closest next levels (smallest xp-to-next)
      const nexts = stats
        .map(([skill, level, xp])=>{
          const lvl = +level||1;
          const curXp = +xp||0;
          if (lvl >= 99) return null;
          const need = Math.max(0, xpForLevel(lvl+1) - curXp);
          return { skill, lvl, need, next: lvl+1 };
        })
        .filter(Boolean)
        .sort((a,b)=> a.need - b.need)
        .slice(0, 5);

      nextLevelsEl.innerHTML = "";
      if (!nexts.length){
        renderRow(nextLevelsEl, "All 99s", "Absolute gamer", true);
      } else {
        for (const n of nexts){
          renderRow(nextLevelsEl, `${n.skill} → ${n.next}`, `${n.need.toLocaleString()} xp to go`, true);
        }
      }

      // Combat focus
      const atk = map.Attack?.level || 1;
      const str = map.Strength?.level || 1;
      const def = map.Defence?.level || 1;
      const rng = map.Ranged?.level || 1;
      const mag = map.Magic?.level || 1;
      const meleeScore = atk + str + def;
      const rangeScore = rng + def;
      const mageScore  = mag + def;

      const focus = [
        {name:"Melee", score: meleeScore},
        {name:"Ranged", score: rangeScore},
        {name:"Magic", score: mageScore}
      ].sort((a,b)=> b.score - a.score);

      combatFocusEl.innerHTML = "";
      renderRow(combatFocusEl, "Leaning", focus[0].name, true);
      renderRow(combatFocusEl, "Melee (A+S+D)", meleeScore.toString(), true);
      renderRow(combatFocusEl, "Ranged (R+D)", rangeScore.toString(), true);
      renderRow(combatFocusEl, "Magic (M+D)", mageScore.toString(), true);

      // Milestones
      milestonesEl.innerHTML = "";
      if (totalXp == null){
        renderRow(milestonesEl, "Total XP", "—", true);
      } else {
        const { last, next } = nearestMilestone(totalXp);
        renderRow(milestonesEl, "Current", `${Number(totalXp).toLocaleString()} xp`, true);
        renderRow(milestonesEl, "Last milestone", last ? `${Number(last).toLocaleString()} xp` : "None", true);
        renderRow(milestonesEl, "Next milestone", next ? `${Number(next).toLocaleString()} xp` : "Max? (lol)", true);
      }
    }

    function renderProfile(name, skills, overall){
      const levels = {};
      for (const [skill, level] of skills) levels[skill] = Number(level) || 1;

      playerNameEl.textContent = name;
      totalLevelEl.textContent = (overall?.totalLevel != null) ? Number(overall.totalLevel).toLocaleString() : "-";
      totalXpEl.textContent = (overall?.totalXp != null) ? Number(overall.totalXp).toLocaleString() : "-";
      combatLevelEl.textContent = calcCombat(levels);

      renderSkills(skills);

      const ts = new Date();
      skillsMeta.textContent = `Loaded ${skills.length} skills • ${ts.toLocaleTimeString()}`;

      lastLoaded = { name, skills, overall };

      // If user is currently on Activities tab, refresh it.
      const activeTab = tabs.find(t => t.classList.contains("active"))?.dataset.tab || "skills";
      if (activeTab === "activities") renderActivities(lastLoaded);
    }

    function fetchWithTimeout(url, ms=9000){
      const controller = new AbortController();
      const t = setTimeout(()=>controller.abort(), ms);
      return fetch(url, { signal: controller.signal }).finally(()=>clearTimeout(t));
    }

    async function fetchHiscores(player){
      const url = `${PROXY_BASE.replace(/\/$/,"")}/hiscores?player=${encodeURIComponent(player)}`;
      const res = await fetchWithTimeout(url, 9000);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const text = await res.text();
      const rows = text.trim().split("\n");
      if (!rows.length) throw new Error("No rows returned");

      const overallRow = rows[0]?.split(",").map(Number);
      const overall = (overallRow && overallRow.length >= 3) ? {
        rank: overallRow[0],
        totalLevel: overallRow[1],
        totalXp: overallRow[2]
      } : null;

      const skillRows = rows.slice(1);
      const skills = [];
      for (let i = 0; i < skillRows.length; i++){
        const line = skillRows[i];
        if (!line) continue;
        const [rank, level, xp] = line.split(",").map(Number);
        if (![rank, level, xp].every(n => Number.isFinite(n))) continue;
        const name = HISCORES_SKILLS[i] || `Unknown ${i+1}`;
        skills.push([name, level, xp, rank]);
      }

      // Order known skills first
      const idx = Object.fromEntries(HISCORES_SKILLS.map((s,i)=>[s,i]));
      skills.sort((a,b)=> (idx[a[0]] ?? 9999) - (idx[b[0]] ?? 9999));

      if (!skills.length) throw new Error("Could not parse skills");
      return { name: player, skills, overall };
    }

    function setUrlPlayer(player){
      const url = new URL(window.location.href);
      url.searchParams.set("p", player);
      history.replaceState({}, "", url);
    }

    function getUrlPlayer(){
      const url = new URL(window.location.href);
      const p = url.searchParams.get("p");
      return p ? p.trim() : "";
    }

    async function handleLookup(player, { updateUrl=true } = {}){
      const p = (player || "").trim();
      if (!p) return;

      localStorage.setItem("woes_armory_last_player", p);
      if (updateUrl) setUrlPlayer(p);

      setStatus("Looking up player...", "");
      lookupBtn.disabled = true;

      try{
        const data = await fetchHiscores(p);
        renderProfile(data.name, data.skills, data.overall);
        setStatus("Live hiscores loaded.", "ok");
      }catch(err){
        const msg = (err && err.name === "AbortError") ? "Request timed out" : (err?.message || "Unknown error");
        setStatus(`Lookup failed (${msg}).`, "error");
      }finally{
        lookupBtn.disabled = false;
      }
    }

    document.getElementById("lookupForm").addEventListener("submit", (e)=>{
      e.preventDefault();
      handleLookup(playerInput.value, { updateUrl:true });
    });

    // Initial UI
    skillsGrid.innerHTML = `<div class="skill" style="grid-column:1/-1; justify-content:center;">
      <div class="skill-main" style="text-align:center;">
        Enter an RSN and click <b>Lookup</b>.
        <div class="skill-sub" style="justify-content:center; margin-top:6px;">Pro tip: share this page with <b>?p=Name</b>.</div>
      </div>
    </div>`;

    // Auto-load from URL (?p=)
    const urlPlayer = getUrlPlayer();
    if (urlPlayer){
      playerInput.value = urlPlayer;
      handleLookup(urlPlayer, { updateUrl:false });
    } else {
      // Otherwise just prefill last used
      const last = localStorage.getItem("woes_armory_last_player");
      if (last) playerInput.value = last;
      playerInput.focus();
    }
  })();
  </script>
</body>
</html>
